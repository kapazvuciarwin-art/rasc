<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCO2 ç›£æ§å„€è¡¨æ¿</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Segoe UI", "Noto Sans TC", sans-serif;
            background: #111827;
            color: #e8e8e8;
            padding: clamp(10px, 1.6vw, 20px);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            margin-bottom: 20px;
            gap: clamp(8px, 1.2vw, 14px);
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: clamp(12px, 1.3vw, 18px);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-card h3 {
            font-size: 0.9em;
            color: #a1a1aa;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-card .value {
            font-size: clamp(1.4rem, 2.6vw, 2.1rem);
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .status-card .unit {
            font-size: 1em;
            color: #a1a1aa;
        }
        
        .status-card.co2 .value { color: #60a5fa; }
        .status-card.temp .value { color: #f87171; }
        .status-card.humidity .value { color: #34d399; }
        .status-card.rssi .value { color: #a78bfa; }
        .status-card.cpu .value { color: #f59e0b; }
        .status-card.ram .value { color: #22d3ee; }
        .status-card.cpu-temp .value { color: #f97316; }
        
        .status-card .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        
        .status-card .status-indicator.active {
            background: #10b981;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.5em;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .metric-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 14px;
            margin-bottom: 16px;
            color: #d4d4d8;
            font-size: 0.92em;
        }

        .metric-toggles label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn.active {
            background: #3b82f6;
        }
        
        .timestamp {
            text-align: center;
            color: #a1a1aa;
            margin-top: 20px;
            font-size: 0.9em;
        }
        
        .no-data {
            text-align: center;
            color: #a1a1aa;
            padding: 40px;
            font-size: 1.2em;
        }
        
        /* è¨­å®šæ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background: #1a1f2e;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .small-help {
            color: #a1a1aa;
            font-size: 0.85em;
            margin-top: 6px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            color: #fff;
            margin: 0;
        }
        
        .close {
            color: #a1a1aa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e8e8e8;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .threshold-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .threshold-section h3 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .history-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .history-container {
            display: none;
        }
        
        .history-container.visible {
            display: block;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="myras-quick-nav" style="margin-bottom:14px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.16); font-size:0.9rem;"></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; gap: 10px; flex-wrap: wrap;">
            <h1 style="margin: 0; font-size: clamp(1.4rem, 2.8vw, 2.2rem);">ğŸŒ¡ï¸ MyCO2 ç’°å¢ƒç›£æ§å„€è¡¨æ¿</h1>
            <button class="btn" onclick="openSettings()" style="padding: 12px 24px; font-size: 1em;">âš™ï¸ é€šçŸ¥è¨­å®š</button>
        </div>
        
        <div class="status-bar">
            <div class="status-card co2">
                <h3>COâ‚‚ æ¿ƒåº¦</h3>
                <div class="value" id="co2-value">--</div>
                <div class="unit">ppm</div>
                <span class="status-indicator" id="co2-indicator"></span>
            </div>
            
            <div class="status-card temp">
                <h3>æº«åº¦</h3>
                <div class="value" id="temp-value">--</div>
                <div class="unit">Â°C</div>
                <span class="status-indicator" id="temp-indicator"></span>
            </div>
            
            <div class="status-card humidity">
                <h3>æ¿•åº¦</h3>
                <div class="value" id="humidity-value">--</div>
                <div class="unit">%</div>
                <span class="status-indicator" id="humidity-indicator"></span>
            </div>
            
            <div class="status-card rssi">
                <h3>è¨Šè™Ÿå¼·åº¦</h3>
                <div class="value" id="rssi-value">--</div>
                <div class="unit">dBm</div>
                <span class="status-indicator" id="rssi-indicator"></span>
            </div>

            <div class="status-card cpu">
                <h3>CPU ä½¿ç”¨ç‡</h3>
                <div class="value" id="cpu-usage-value">--</div>
                <div class="unit">%</div>
                <span class="status-indicator" id="cpu-usage-indicator"></span>
            </div>

            <div class="status-card ram">
                <h3>RAM ä½¿ç”¨ç‡</h3>
                <div class="value" id="ram-usage-value">--</div>
                <div class="unit">%</div>
                <span class="status-indicator" id="ram-usage-indicator"></span>
            </div>

            <div class="status-card cpu-temp">
                <h3>CPU æº«åº¦</h3>
                <div class="value" id="cpu-temp-value">--</div>
                <div class="unit">Â°C</div>
                <span class="status-indicator" id="cpu-temp-indicator"></span>
            </div>

        </div>
        
        <div class="history-buttons">
            <button class="btn" onclick="showHistoryChart()">ğŸ“ˆ é¡¯ç¤ºæŠ˜ç·šåœ–</button>
            <button class="btn" onclick="refreshCurrentHistory()">ğŸ”„ é‡æ–°è¼‰å…¥æŠ˜ç·šåœ–</button>
        </div>
        
        <div class="chart-container history-container" id="chartContainer">
            <h2>æ­·å²æ•¸æ“š - æŠ˜ç·šåœ–</h2>
            <div class="controls">
                <button class="btn active" onclick="loadHistory(1, this)">1å°æ™‚</button>
                <button class="btn" onclick="loadHistory(6, this)">6å°æ™‚</button>
                <button class="btn" onclick="loadHistory(24, this)">24å°æ™‚</button>
                <button class="btn" onclick="loadHistory(48, this)">48å°æ™‚</button>
            </div>
            <div class="metric-toggles" id="metricToggles">
                <label><input type="checkbox" value="co2_ppm" checked>COâ‚‚</label>
                <label><input type="checkbox" value="temperature_c" checked>æº«åº¦</label>
                <label><input type="checkbox" value="humidity" checked>æ¿•åº¦</label>
                <label><input type="checkbox" value="rssi">è¨Šè™Ÿå¼·åº¦</label>
                <label><input type="checkbox" value="cpu_usage_percent">CPU ä½¿ç”¨ç‡</label>
                <label><input type="checkbox" value="ram_usage_percent">RAM ä½¿ç”¨ç‡</label>
                <label><input type="checkbox" value="cpu_temp_c">CPU æº«åº¦</label>
            </div>
            <canvas id="historyChart"></canvas>
        </div>
        
        <div class="timestamp" id="last-update">
            æœ€å¾Œæ›´æ–°: --
        </div>
    </div>
    
    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“± Telegram é€šçŸ¥è¨­å®š</h2>
                <button class="close" onclick="closeSettings()">&times;</button>
            </div>
            <div id="settingsAlert"></div>
            <form id="settingsForm">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enabled" onchange="toggleSettings()">
                        å•Ÿç”¨ Telegram é€šçŸ¥
                    </label>
                </div>
                
                <div id="settingsFields" style="display: none;">
                    <div class="form-group">
                        <label>Bot Token</label>
                        <input type="text" id="bot_token" placeholder="ä¾‹å¦‚: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    </div>
                    
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="text" id="chat_id" placeholder="ä¾‹å¦‚: 123456789">
                    </div>
                    
                    <div class="threshold-section">
                        <h3>ç•«é¢æ›´æ–°é »ç‡</h3>
                        <div class="form-group">
                            <label>æ›´æ–°é–“éš”ï¼ˆç§’ï¼‰</label>
                            <input type="number" id="refresh_seconds" min="2" max="3600" step="1" value="10">
                            <div class="small-help">é è¨­ 10 ç§’ã€‚èª¿æ•´å¾Œæœƒç«‹å³ç”Ÿæ•ˆä¸¦ä¿å­˜åœ¨æ­¤ç€è¦½å™¨ã€‚</div>
                        </div>
                    </div>

                    <div class="threshold-section">
                        <h3>COâ‚‚ æ¿ƒåº¦ (ppm)</h3>
                        <label>
                            <input type="checkbox" id="co2_enabled">
                            å•Ÿç”¨ COâ‚‚ é€šçŸ¥
                        </label>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>æœ€å°å€¼</label>
                                <input type="number" id="co2_min" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å€¼</label>
                                <input type="number" id="co2_max" placeholder="ä¾‹å¦‚: 1000">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="co2_cooldown" value="30" min="1">
                        </div>
                    </div>
                    
                    <div class="threshold-section">
                        <h3>æº«åº¦ (Â°C)</h3>
                        <label>
                            <input type="checkbox" id="temp_enabled">
                            å•Ÿç”¨æº«åº¦é€šçŸ¥
                        </label>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>æœ€å°å€¼</label>
                                <input type="number" id="temp_min" placeholder="ä¾‹å¦‚: 10">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å€¼</label>
                                <input type="number" id="temp_max" placeholder="ä¾‹å¦‚: 30">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="temp_cooldown" value="30" min="1">
                        </div>
                    </div>
                    
                    <div class="threshold-section">
                        <h3>æ¿•åº¦ (%)</h3>
                        <label>
                            <input type="checkbox" id="humidity_enabled">
                            å•Ÿç”¨æ¿•åº¦é€šçŸ¥
                        </label>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>æœ€å°å€¼</label>
                                <input type="number" id="humidity_min" placeholder="ä¾‹å¦‚: 30">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å€¼</label>
                                <input type="number" id="humidity_max" placeholder="ä¾‹å¦‚: 70">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="humidity_cooldown" value="30" min="1">
                        </div>
                    </div>

                    <div class="threshold-section">
                        <h3>RAM ä½¿ç”¨ç‡ (%)</h3>
                        <label>
                            <input type="checkbox" id="ram_enabled">
                            å•Ÿç”¨ RAM é€šçŸ¥
                        </label>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>æœ€å°å€¼</label>
                                <input type="number" id="ram_min" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å€¼</label>
                                <input type="number" id="ram_max" placeholder="ä¾‹å¦‚: 90">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <input type="number" id="ram_cooldown" value="30" min="1">
                        </div>
                    </div>
                    
                    <button type="button" class="btn-secondary" onclick="testTelegram()">æ¸¬è©¦é€šçŸ¥</button>
                    <button type="submit" class="btn-primary">å„²å­˜è¨­å®š</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // WebSocket é€£æ¥
        const socket = io();
        
        // åœ–è¡¨
        let historyChart = null;
        let currentHours = 24;
        let refreshTimer = null;
        let isSettingsOpen = false;
        let lastHistoryData = [];
        const MAX_HISTORY_POINTS = 360;

        const CHART_METRICS = [
            { key: 'co2_ppm', label: 'COâ‚‚ (ppm)', color: '#60a5fa', axis: 'y' },
            { key: 'temperature_c', label: 'æº«åº¦ (Â°C)', color: '#f87171', axis: 'y1' },
            { key: 'humidity', label: 'æ¿•åº¦ (%)', color: '#34d399', axis: 'y1' },
            { key: 'rssi', label: 'è¨Šè™Ÿå¼·åº¦ (dBm)', color: '#a78bfa', axis: 'y1' },
            { key: 'cpu_usage_percent', label: 'CPU ä½¿ç”¨ç‡ (%)', color: '#f59e0b', axis: 'y1' },
            { key: 'ram_usage_percent', label: 'RAM ä½¿ç”¨ç‡ (%)', color: '#22d3ee', axis: 'y1' },
            { key: 'cpu_temp_c', label: 'CPU æº«åº¦ (Â°C)', color: '#f97316', axis: 'y1' }
        ];

        function getRefreshSeconds() {
            const raw = localStorage.getItem('dashboardRefreshSeconds');
            const parsed = Number(raw);
            if (!Number.isFinite(parsed) || parsed < 2 || parsed > 3600) {
                return 10;
            }
            return Math.round(parsed);
        }

        function setRefreshSeconds(seconds) {
            const normalized = Math.max(2, Math.min(3600, Math.round(Number(seconds) || 10)));
            localStorage.setItem('dashboardRefreshSeconds', String(normalized));
            return normalized;
        }
        
        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: CHART_METRICS.map(metric => ({
                        label: metric.label,
                        metricKey: metric.key,
                        data: [],
                        borderColor: metric.color,
                        backgroundColor: `${metric.color}22`,
                        tension: 0.35,
                        yAxisID: metric.axis,
                        hidden: !isMetricChecked(metric.key)
                    }))
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e8e8e8'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#60a5fa' },
                            grid: { color: 'rgba(96, 165, 250, 0.1)' },
                            title: {
                                display: true,
                                text: 'COâ‚‚ (ppm)',
                                color: '#60a5fa'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#d1d5db' },
                            grid: { drawOnChartArea: false },
                            title: {
                                display: true,
                                text: 'å…¶ä»–æ„Ÿæ¸¬å€¼',
                                color: '#d1d5db'
                            }
                        }
                    }
                }
            });
        }

        function isMetricChecked(metricKey) {
            const checkbox = document.querySelector(`#metricToggles input[value="${metricKey}"]`);
            return checkbox ? checkbox.checked : false;
        }

        function applyMetricSelection() {
            if (!historyChart) return;
            historyChart.data.datasets.forEach(dataset => {
                dataset.hidden = !isMetricChecked(dataset.metricKey);
            });
            historyChart.update('none');
        }

        function downsampleHistoryData(data, maxPoints = MAX_HISTORY_POINTS) {
            if (!Array.isArray(data) || data.length <= maxPoints) {
                return data;
            }

            const sampled = [];
            const step = data.length / maxPoints;
            for (let i = 0; i < maxPoints; i++) {
                const index = Math.floor(i * step);
                sampled.push(data[Math.min(index, data.length - 1)]);
            }
            return sampled;
        }

        function updateHistoryChartWithData(data) {
            if (!historyChart) {
                initChart();
            }

            const sampledData = downsampleHistoryData(data);

            if (!sampledData.length) {
                historyChart.data.labels = [];
                historyChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                historyChart.update('none');
                return;
            }

            const labels = sampledData.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Taipei'
                });
            });

            historyChart.data.labels = labels;
            historyChart.data.datasets.forEach(dataset => {
                dataset.data = sampledData.map(row => row[dataset.metricKey]);
                dataset.hidden = !isMetricChecked(dataset.metricKey);
            });
            historyChart.update('none');
        }
        
        // æ›´æ–°é¡¯ç¤ºå€¼
        function updateDisplay(data) {
            if (data.co2_ppm !== null && data.co2_ppm !== undefined) {
                document.getElementById('co2-value').textContent = data.co2_ppm;
                document.getElementById('co2-indicator').classList.add('active');
            }
            
            if (data.temperature_c !== null && data.temperature_c !== undefined) {
                document.getElementById('temp-value').textContent = data.temperature_c.toFixed(1);
                document.getElementById('temp-indicator').classList.add('active');
            }
            
            if (data.humidity !== null && data.humidity !== undefined) {
                document.getElementById('humidity-value').textContent = data.humidity.toFixed(1);
                document.getElementById('humidity-indicator').classList.add('active');
            }
            
            if (data.rssi !== null && data.rssi !== undefined) {
                document.getElementById('rssi-value').textContent = data.rssi;
                document.getElementById('rssi-indicator').classList.add('active');
            }

            if (data.cpu_usage_percent !== null && data.cpu_usage_percent !== undefined) {
                document.getElementById('cpu-usage-value').textContent = Number(data.cpu_usage_percent).toFixed(1);
                document.getElementById('cpu-usage-indicator').classList.add('active');
            }

            if (data.ram_usage_percent !== null && data.ram_usage_percent !== undefined) {
                document.getElementById('ram-usage-value').textContent = Number(data.ram_usage_percent).toFixed(1);
                document.getElementById('ram-usage-indicator').classList.add('active');
            }

            if (data.cpu_temp_c !== null && data.cpu_temp_c !== undefined) {
                document.getElementById('cpu-temp-value').textContent = Number(data.cpu_temp_c).toFixed(1);
                document.getElementById('cpu-temp-indicator').classList.add('active');
            }
            
            if (data.timestamp) {
                const date = new Date(data.timestamp);
                // ä½¿ç”¨å°ç£æ™‚å€é¡¯ç¤º
                document.getElementById('last-update').textContent = 
                    `æœ€å¾Œæ›´æ–°: ${date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}`;
            }
        }

        function updateSystemDisplay(systemData) {
            const setMetric = (id, indicatorId, value, digits = 1) => {
                if (value !== null && value !== undefined && Number.isFinite(Number(value))) {
                    const num = Number(value);
                    document.getElementById(id).textContent = num.toFixed(digits);
                    document.getElementById(indicatorId).classList.add('active');
                }
            };

            setMetric('cpu-usage-value', 'cpu-usage-indicator', systemData.cpu_usage_percent);
            setMetric('ram-usage-value', 'ram-usage-indicator', systemData.ram_usage_percent);

            const temps = systemData.temperatures_c || {};
            setMetric('cpu-temp-value', 'cpu-temp-indicator', temps.cpu);
        }

        async function fetchSystemMetrics() {
            try {
                const response = await fetch('/api/system');
                if (!response.ok) return;
                const data = await response.json();
                updateSystemDisplay(data);
            } catch (error) {
                console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—:', error);
            }
        }

        async function fetchLatestSnapshot() {
            try {
                const response = await fetch('/api/latest');
                if (!response.ok) return;
                const data = await response.json();
                updateDisplay(data);
            } catch (error) {
                console.error('è¼‰å…¥æœ€æ–°æ„Ÿæ¸¬è³‡æ–™å¤±æ•—:', error);
            }
        }

        function restartRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }

            const seconds = getRefreshSeconds();
            refreshTimer = setInterval(() => {
                if (isSettingsOpen) return;
                fetchLatestSnapshot();
                fetchSystemMetrics();
            }, seconds * 1000);
        }
        
        // é¡¯ç¤ºæ­·å²æŠ˜ç·šåœ–
        function showHistoryChart() {
            document.getElementById('chartContainer').classList.add('visible');
            
            // å¦‚æœåœ–è¡¨å°šæœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
            if (!historyChart) {
                initChart();
            }
            
            // è¼‰å…¥é»˜èª24å°æ™‚æ•¸æ“š
            loadHistory(24, null);
        }

        function refreshCurrentHistory() {
            loadHistory(currentHours, null);
        }
        
        // è¼‰å…¥æ­·å²æ•¸æ“šï¼ˆæŠ˜ç·šåœ–ï¼‰
        async function loadHistory(hours, buttonElement) {
            currentHours = hours;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼ˆåªåœ¨åœ–è¡¨å®¹å™¨å…§ï¼‰
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.querySelectorAll('.controls .btn').forEach(btn => btn.classList.remove('active'));
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // å¦‚æœæ²’æœ‰å‚³å…¥æŒ‰éˆ•å…ƒç´ ï¼Œæ‰¾åˆ°å°æ‡‰å°æ™‚çš„æŒ‰éˆ•
                const buttons = chartContainer.querySelectorAll('.controls .btn');
                buttons.forEach(btn => {
                    const btnText = btn.textContent.trim();
                    if ((hours === 1 && btnText === '1å°æ™‚') ||
                        (hours === 6 && btnText === '6å°æ™‚') ||
                        (hours === 24 && btnText === '24å°æ™‚') ||
                        (hours === 48 && btnText === '48å°æ™‚')) {
                        btn.classList.add('active');
                    }
                });
            }
            
            try {
                const response = await fetch(`/api/history?hours=${hours}&max_points=${MAX_HISTORY_POINTS}`);
                const data = await response.json();
                
                if (!historyChart) {
                    initChart();
                }
                lastHistoryData = data;
                updateHistoryChartWithData(data);
                
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²æ•¸æ“šå¤±æ•—:', error);
            }
        }
        
        // WebSocket äº‹ä»¶è™•ç†
        socket.on('connect', () => {
            console.log('å·²é€£æ¥åˆ°ä¼ºæœå™¨');
            // è¼‰å…¥åˆå§‹æ•¸æ“š
            fetchLatestSnapshot();
            fetchSystemMetrics();
            restartRefreshTimer();
            // ä¸å†è‡ªå‹•è¼‰å…¥æ­·å²æ•¸æ“šï¼Œç­‰å¾…ç”¨æˆ¶é»æ“ŠæŒ‰éˆ•
        });
        
        socket.on('sensor_update', (data) => {
            updateDisplay(data);
        });
        
        // åˆå§‹åŒ–ï¼ˆä½†ä¸è¼‰å…¥æ•¸æ“šï¼‰
        // åœ–è¡¨å°‡åœ¨ç”¨æˆ¶é»æ“ŠæŒ‰éˆ•æ™‚æ‰åˆå§‹åŒ–
        
        // è¨­å®šç›¸é—œå‡½æ•¸
        function openSettings() {
            isSettingsOpen = true;
            document.getElementById('settingsModal').style.display = 'block';
            loadSettings();
        }
        
        function closeSettings() {
            isSettingsOpen = false;
            document.getElementById('settingsModal').style.display = 'none';
            document.getElementById('settingsAlert').innerHTML = '';
            fetchLatestSnapshot();
            fetchSystemMetrics();
        }
        
        function toggleSettings() {
            const enabled = document.getElementById('enabled').checked;
            document.getElementById('settingsFields').style.display = enabled ? 'block' : 'none';
        }
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/telegram/config');
                const config = await response.json();
                
                document.getElementById('enabled').checked = config.enabled || false;
                toggleSettings();
                
                if (config.bot_token && config.bot_token !== '***') {
                    document.getElementById('bot_token').value = config.bot_token;
                }
                document.getElementById('chat_id').value = config.chat_id || '';
                
                // CO2 è¨­å®š
                const co2 = config.thresholds.co2_ppm || {};
                document.getElementById('co2_enabled').checked = co2.enabled || false;
                document.getElementById('co2_min').value = co2.min || '';
                document.getElementById('co2_max').value = co2.max || '';
                document.getElementById('co2_cooldown').value = co2.cooldown_minutes || 30;
                
                // æº«åº¦è¨­å®š
                const temp = config.thresholds.temperature_c || {};
                document.getElementById('temp_enabled').checked = temp.enabled || false;
                document.getElementById('temp_min').value = temp.min || '';
                document.getElementById('temp_max').value = temp.max || '';
                document.getElementById('temp_cooldown').value = temp.cooldown_minutes || 30;
                
                // æ¿•åº¦è¨­å®š
                const humidity = config.thresholds.humidity || {};
                document.getElementById('humidity_enabled').checked = humidity.enabled || false;
                document.getElementById('humidity_min').value = humidity.min || '';
                document.getElementById('humidity_max').value = humidity.max || '';
                document.getElementById('humidity_cooldown').value = humidity.cooldown_minutes || 30;

                // RAM ä½¿ç”¨ç‡è¨­å®š
                const ram = config.thresholds.ram_usage_percent || {};
                document.getElementById('ram_enabled').checked = ram.enabled || false;
                document.getElementById('ram_min').value = ram.min || '';
                document.getElementById('ram_max').value = ram.max || '';
                document.getElementById('ram_cooldown').value = ram.cooldown_minutes || 30;

                document.getElementById('refresh_seconds').value = getRefreshSeconds();
            } catch (error) {
                showAlert('è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }
        
        async function saveSettings(event) {
            event.preventDefault();

            const refreshSecondsInput = document.getElementById('refresh_seconds').value;
            const refreshSeconds = setRefreshSeconds(refreshSecondsInput);
            restartRefreshTimer();
            fetchLatestSnapshot();
            fetchSystemMetrics();
            
            const config = {
                enabled: document.getElementById('enabled').checked,
                bot_token: document.getElementById('bot_token').value,
                chat_id: document.getElementById('chat_id').value,
                thresholds: {
                    co2_ppm: {
                        enabled: document.getElementById('co2_enabled').checked,
                        min: document.getElementById('co2_min').value ? parseFloat(document.getElementById('co2_min').value) : null,
                        max: document.getElementById('co2_max').value ? parseFloat(document.getElementById('co2_max').value) : null,
                        cooldown_minutes: parseInt(document.getElementById('co2_cooldown').value) || 30
                    },
                    temperature_c: {
                        enabled: document.getElementById('temp_enabled').checked,
                        min: document.getElementById('temp_min').value ? parseFloat(document.getElementById('temp_min').value) : null,
                        max: document.getElementById('temp_max').value ? parseFloat(document.getElementById('temp_max').value) : null,
                        cooldown_minutes: parseInt(document.getElementById('temp_cooldown').value) || 30
                    },
                    humidity: {
                        enabled: document.getElementById('humidity_enabled').checked,
                        min: document.getElementById('humidity_min').value ? parseFloat(document.getElementById('humidity_min').value) : null,
                        max: document.getElementById('humidity_max').value ? parseFloat(document.getElementById('humidity_max').value) : null,
                        cooldown_minutes: parseInt(document.getElementById('humidity_cooldown').value) || 30
                    },
                    ram_usage_percent: {
                        enabled: document.getElementById('ram_enabled').checked,
                        min: document.getElementById('ram_min').value ? parseFloat(document.getElementById('ram_min').value) : null,
                        max: document.getElementById('ram_max').value ? parseFloat(document.getElementById('ram_max').value) : null,
                        cooldown_minutes: parseInt(document.getElementById('ram_cooldown').value) || 30
                    }
                }
            };
            
            try {
                const response = await fetch('/api/telegram/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(`è¨­å®šå·²å„²å­˜ï¼æ›´æ–°é »ç‡ï¼šæ¯ ${refreshSeconds} ç§’`, 'success');
                } else {
                    showAlert('å„²å­˜å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showAlert('å„²å­˜å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        async function testTelegram() {
            // å…ˆæª¢æŸ¥é…ç½®æ˜¯å¦å·²è¨­å®š
            const botToken = document.getElementById('bot_token').value.trim();
            const chatId = document.getElementById('chat_id').value.trim();
            
            if (!botToken) {
                showAlert('è«‹å…ˆå¡«å…¥ Bot Token', 'error');
                return;
            }
            
            if (!chatId) {
                showAlert('è«‹å…ˆå¡«å…¥ Chat ID', 'error');
                return;
            }
            
            try {
                showAlert('æ­£åœ¨ç™¼é€æ¸¬è©¦é€šçŸ¥...', 'success');
                const response = await fetch('/api/telegram/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showAlert('âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ Telegramã€‚', 'success');
                } else {
                    const errorMsg = result.error || `HTTP ${response.status}: ${response.statusText}`;
                    showAlert('âŒ æ¸¬è©¦å¤±æ•—: ' + errorMsg, 'error');
                    console.error('Telegram æ¸¬è©¦å¤±æ•—:', result);
                }
            } catch (error) {
                showAlert('âŒ æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                console.error('Telegram æ¸¬è©¦ç•°å¸¸:', error);
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('settingsAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        
        // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);
        document.querySelectorAll('#metricToggles input[type="checkbox"]').forEach(input => {
            input.addEventListener('change', () => {
                if (historyChart) {
                    if (lastHistoryData.length) {
                        updateHistoryChartWithData(lastHistoryData);
                    } else {
                        applyMetricSelection();
                    }
                }
            });
        });
        document.getElementById('refresh_seconds').addEventListener('change', (event) => {
            const seconds = setRefreshSeconds(event.target.value);
            event.target.value = seconds;
        });
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target == modal) {
                closeSettings();
            }
        };

        (function renderMyrasQuickNav() {
            const mount = document.getElementById('myras-quick-nav');
            if (!mount) return;
            const base = `${window.location.protocol}//${window.location.hostname}:5010`;
            fetch(`${base}/api/projects`)
                .then(r => r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`)))
                .then(items => {
                    const list = Array.isArray(items) ? items : [];
                    if (!list.length) {
                        mount.innerHTML = `<a href="${base}" style="color:#93c5fd;">å› myras</a>`;
                        return;
                    }
                    const buttons = list.map(p => {
                        const name = String(p.name || 'æœªå‘½å');
                        const url = String(p.url || '#');
                        return `<a href="${url}" style="display:inline-block; margin:4px 6px 0 0; padding:6px 10px; border-radius:8px; text-decoration:none; color:#fff; background:rgba(59,130,246,0.55); border:1px solid rgba(147,197,253,0.4);">${name}</a>`;
                    }).join('');
                    mount.innerHTML = buttons;
                })
                .catch(() => {
                    mount.innerHTML = `<a href="${base}" style="color:#93c5fd;">å› myras</a>`;
                });
        })();
    </script>
</body>
</html>
