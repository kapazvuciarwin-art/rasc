# 濕度數據發現與實現

## 發現過程

通過分析 MyCO2 設備的 20 bytes 通知數據，發現了濕度數據的位置和格式。

## 數據格式

### 通知特徵值
- **UUID**: `00008004-b38d-4985-720e-0f993a68ee41`
- **數據長度**: 20 bytes
- **更新頻率**: 設備主動推送（實時）

### 數據結構分析

從實際數據 `03009463e85ff301000094632160f50100000000` 分析：

```
字節位置    值 (big-endian)    除以100後    可能的感測器
----------------------------------------------------------
0           序號 (3)
2-4         37987              379.87       (可能是其他數據)
4-6         59487              594.87       (可能是其他數據)
12-14       8544               85.44%       ✅ 濕度！
14-16       501                5.01         (可能是CO2，但值太小)
```

### 濕度數據位置

- **位置**: bytes 12-14
- **格式**: big-endian, 16-bit 無符號整數
- **單位**: 除以 100 後得到百分比（0-100%）
- **範例**: `8544` (hex: `2160`) / 100 = `85.44%`

## 實現

已在 `app.py` 中實現：

1. **新增通知處理器** `notification_handler_20bytes()`
   - 解析 20 bytes 通知數據
   - 提取 CO2、溫度、濕度
   - 自動保存到資料庫

2. **濕度解析函數** `parse_humidity_data()`
   - 支援多種格式解析
   - 驗證數據合理性（0-100%）

3. **自動訂閱**
   - 連接設備後自動訂閱 `00008004` 特徵值
   - 接收實時感測器數據

## 數據更新頻率

- **CO2**: 約每 5 秒（BLE 通知）
- **溫度**: 每 30 秒（主動讀取，因為不支持通知）
- **濕度**: 約每 5 秒（透過 20 bytes 通知數據）

## 驗證

可以通過以下方式驗證：

```bash
# 查看資料庫中的濕度數據
cd /home/kapraspi/rasc
source venv/bin/activate
python3 check_data.py

# 查看服務日誌
journalctl --user -u rasc.service -f | grep -E "濕度|humidity|20 bytes"
```

## 注意事項

1. 設備需要在範圍內並已開啟
2. 20 bytes 通知數據需要設備主動推送
3. 如果設備未連接，濕度數據不會更新
4. 濕度值會自動顯示在網站上（一旦有數據）
